---
name: Strapi PostgreSQL GraphQL 3D Graph Migrations
overview: Design and implement Strapi content types and PostgreSQL schema optimized for 3D graph visualization of TTOD wisdom database, with YAML as source of truth and automated sync mechanism.
todos: []
---

# Strapi + PostgreSQL Migrations for 3D Graph Visualization

## Architecture Overview

**Stack:** Strapi CMS + PostgreSQL + Auto-generated GraphQL API

**Source of Truth:** `web-foundations/docs/_data/ttod.yml` (YAML)

**Sync Strategy:** Periodic YAML → Strapi sync (hybrid approach)

**GraphQL:** Auto-generated by Strapi with custom resolvers for graph queries

## Database Schema Design

### Core Content Types

#### 1. **Quote** (Main Entity)

Primary content type for wisdom quotes, optimized for graph nodes.

**Fields:**

- `id` (UID, auto-generated)
- `quoteId` (String, unique, indexed) - e.g., "cc-015"
- `text` (Text, required)
- `section` (Relation: Section, required, indexed)
- `subsection` (String, indexed)
- `level` (Enum: beginner, intermediate, advanced, master, indexed)
- `levelWeight` (Number, 0-3) - For Z-depth calculation
- `tags` (Relation: Tag, many-to-many)
- `teaches` (Text, long text)
- `chapter` (String)
- `lesson` (Relation: Lesson, optional)
- `source` (String)
- `koan` (String, optional)
- `featured` (Boolean, indexed)
- `createdAt` (DateTime)
- `updatedAt` (DateTime)

**GraphQL Optimizations:**

- Index on `quoteId` for fast lookups
- Index on `section` + `level` for filtering
- Index on `featured` for featured queries
- Composite index on `(section, subsection, level)` for clustering queries

#### 2. **Section** (Reference Entity)

Metadata for sections (images, code-craft, wisdom, etc.)

**Fields:**

- `id` (UID)
- `sectionId` (String, unique) - e.g., "code-craft"
- `name` (String)
- `prefix` (String) - e.g., "cc"
- `icon` (String) - Emoji
- `color` (String, hex) - For node coloring
- `description` (Text)
- `subsections` (JSON) - Array of subsection names
- `quotes` (Relation: Quote, one-to-many, reverse)

**GraphQL:** Provides color/icon for node rendering

#### 3. **Tag** (Many-to-Many)

Tags for filtering and semantic grouping

**Fields:**

- `id` (UID)
- `name` (String, unique, indexed)
- `category` (Enum: technical, pedagogical, source, philosophy)
- `quotes` (Relation: Quote, many-to-many)

**GraphQL:** Efficient tag-based filtering

#### 4. **QuoteRelationship** (Edge Entity)

Explicit edges for graph visualization with strength and type

**Fields:**

- `id` (UID)
- `source` (Relation: Quote, required, indexed)
- `target` (Relation: Quote, required, indexed)
- `relationshipType` (Enum: same_subsection, same_lesson, semantic_link, progression, contrast)
- `strength` (Number, 0-1) - For edge width/opacity
- `color` (String, hex) - Override default edge color
- `createdAt` (DateTime)

**GraphQL Optimizations:**

- Composite index on `(source, target)` for fast edge queries
- Index on `relationshipType` for filtering
- Unique constraint on `(source, target)` to prevent duplicates

**Note:** This replaces the `related` array in YAML with explicit edges for better graph queries.

#### 5. **Lesson** (Reference Entity)

Pedagogical lessons that group quotes

**Fields:**

- `id` (UID)
- `lessonId` (String, unique) - e.g., "the-tao-of-web-images"
- `title` (String)
- `titleAlt` (String) - Spanish title
- `author` (String)
- `date` (Date)
- `section` (String)
- `path` (String)
- `description` (Text)
- `tags` (JSON) - Array of tag names
- `quotes` (Relation: Quote, many-to-many)

#### 6. **Collection** (Reference Entity)

Curated collections of quotes

**Fields:**

- `id` (UID)
- `collectionId` (String, unique)
- `name` (String)
- `description` (Text)
- `filter` (String) - Query filter expression
- `quotes` (Relation: Quote, many-to-many)

#### 7. **VisualizationConfig** (Singleton)

3D graph rendering configuration

**Fields:**

- `id` (UID)
- `layoutAlgorithm` (String) - "force-directed-3d"
- `clusteringStrategy` (String) - "section"
- `zAxisMapping` (String) - "level"
- `nodeSizeMapping` (String) - "connection_count"
- `nodeColorMapping` (String) - "section"
- `nodeOpacityMapping` (String) - "level_weight"
- `edgeColorMapping` (String) - "relationship_type"
- `edgeWidthMapping` (String) - "strength"
- `cameraDistance` (Number)
- `fogNear` (Number)
- `fogFar` (Number)
- `particleSize` (Number)
- `linkOpacity` (Number)
- `bloomEnabled` (Boolean)
- `bloomStrength` (Number)
- `relationshipTypes` (JSON) - Array of relationship type configs

## PostgreSQL Indexes for Performance

### Critical Indexes

```sql
-- Quote lookups
CREATE INDEX idx_quote_quote_id ON quotes(quote_id);
CREATE INDEX idx_quote_section_level ON quotes(section_id, level);
CREATE INDEX idx_quote_featured ON quotes(featured) WHERE featured = true;
CREATE INDEX idx_quote_section_subsection_level ON quotes(section_id, subsection, level);

-- Relationship queries (edges)
CREATE INDEX idx_relationship_source_target ON quote_relationships(source_id, target_id);
CREATE INDEX idx_relationship_type ON quote_relationships(relationship_type);
CREATE INDEX idx_relationship_source ON quote_relationships(source_id);
CREATE INDEX idx_relationship_target ON quote_relationships(target_id);

-- Tag filtering
CREATE INDEX idx_quote_tags ON quotes_tags(quote_id, tag_id);
CREATE INDEX idx_tag_name ON tags(name);

-- Graph traversal
CREATE INDEX idx_quote_section_cluster ON quotes(section_id) WHERE section_id IS NOT NULL;
```

### Materialized Views (Optional, for complex queries)

```sql
-- Pre-computed node statistics for graph layout
CREATE MATERIALIZED VIEW quote_node_stats AS
SELECT 
  q.id,
  q.quote_id,
  COUNT(DISTINCT r1.target_id) + COUNT(DISTINCT r2.source_id) as connection_count,
  s.color as node_color,
  q.level_weight as z_depth
FROM quotes q
LEFT JOIN quote_relationships r1 ON q.id = r1.source_id
LEFT JOIN quote_relationships r2 ON q.id = r2.target_id
LEFT JOIN sections s ON q.section_id = s.id
GROUP BY q.id, q.quote_id, s.color, q.level_weight;

CREATE UNIQUE INDEX ON quote_node_stats(id);
```

## GraphQL Schema Optimizations

### Custom Queries for 3D Graphs

#### 1. **Graph Query** (Optimized for initial load)

```graphql
query GetGraphData($filters: QuoteFiltersInput) {
  quotes(filters: $filters) {
    id
    quoteId
    text
    level
    levelWeight
    section {
      id
      sectionId
      name
      color
      icon
    }
    tags {
      name
    }
    # Pre-computed connection count
    connectionCount
  }
  quoteRelationships(filters: { source: { id: { in: $quoteIds } } }) {
    id
    source {
      id
      quoteId
    }
    target {
      id
      quoteId
    }
    relationshipType
    strength
    color
  }
  visualizationConfig {
    layoutAlgorithm
    clusteringStrategy
    zAxisMapping
    nodeColorMapping
    edgeColorMapping
    relationshipTypes
  }
}
```

#### 2. **Filtered Graph Query** (For interactive filtering)

```graphql
query GetFilteredGraph(
  $sections: [ID]
  $levels: [String]
  $tags: [String]
  $featured: Boolean
) {
  quotes(
    filters: {
      section: { id: { in: $sections } }
      level: { in: $levels }
      tags: { name: { in: $tags } }
      featured: { eq: $featured }
    }
  ) {
    id
    quoteId
    # ... same as above
  }
  # Only edges between visible nodes
  quoteRelationships(
    filters: {
      and: [
        { source: { id: { in: $visibleNodeIds } } }
        { target: { id: { in: $visibleNodeIds } } }
      ]
    }
  ) {
    # ... same as above
  }
}
```

#### 3. **Node Details Query** (For tooltips/sidebar)

```graphql
query GetQuoteDetails($id: ID!) {
  quote(id: $id) {
    id
    quoteId
    text
    teaches
    section {
      name
      color
      icon
    }
    subsection
    level
    tags {
      name
      category
    }
    chapter
    lesson {
      title
      path
    }
    source
    koan
    # Related quotes (via relationships)
    relationships {
      target {
        id
        quoteId
        text
      }
      relationshipType
      strength
    }
  }
}
```

### Custom Resolvers (Strapi Lifecycle Hooks)

**After Create/Update Quote:**

- Auto-calculate `connectionCount` from relationships
- Update materialized view if used
- Invalidate GraphQL cache

**After Create/Update Relationship:**

- Update `connectionCount` for both source and target quotes
- Validate relationship (prevent self-loops, duplicates)

## YAML Sync Mechanism

### Sync Script Architecture

**Location:** `web-foundations/scripts/sync-ttod-to-strapi.mjs`

**Process:**

1. Parse `ttod.yml` using `js-yaml`
2. Validate schema against Strapi content types
3. Upsert Sections (idempotent by `sectionId`)
4. Upsert Tags (idempotent by `name`)
5. Upsert Lessons (idempotent by `lessonId`)
6. Upsert Quotes (idempotent by `quoteId`)
7. Build QuoteRelationships from `related` arrays
8. Update VisualizationConfig from `visualization` section
9. Log sync results and errors

**Key Features:**

- Non-destructive: Only creates/updates, never deletes
- Idempotent: Can run multiple times safely
- Dry-run mode: Validate without writing
- Incremental: Only sync changed quotes (compare `updatedAt`)

### Sync Command

```bash
# Full sync
npm run sync:ttod

# Dry run (validate only)
npm run sync:ttod -- --dry-run

# Incremental (only changed)
npm run sync:ttod -- --incremental
```

## Migration Files

### 1. Initial Schema Migration

**File:** `strapi/database/migrations/001_create_ttod_schema.js`

Creates all content types, indexes, and initial data.

### 2. Relationship Migration

**File:** `strapi/database/migrations/002_build_relationships.js`

Converts YAML `related` arrays to explicit `QuoteRelationship` edges.

### 3. Materialized View Migration (Optional)

**File:** `strapi/database/migrations/003_create_node_stats_view.js`

Creates materialized view for performance.

## Implementation Files

### Strapi Content Types

- `strapi/src/api/quote/content-types/quote/schema.json`
- `strapi/src/api/section/content-types/section/schema.json`
- `strapi/src/api/tag/content-types/tag/schema.json`
- `strapi/src/api/quote-relationship/content-types/quote-relationship/schema.json`
- `strapi/src/api/lesson/content-types/lesson/schema.json`
- `strapi/src/api/collection/content-types/collection/schema.json`
- `strapi/src/api/visualization-config/content-types/visualization-config/schema.json`

### Custom Resolvers

- `strapi/src/api/quote/controllers/quote.js` - Custom GraphQL resolvers
- `strapi/src/api/quote/services/quote.js` - Connection count calculation
- `strapi/src/api/quote-relationship/services/relationship.js` - Edge validation

### Sync Script

- `web-foundations/scripts/sync-ttod-to-strapi.mjs` - YAML → Strapi sync

## Performance Considerations

### Query Optimization

- Use DataLoader pattern for batch loading relationships
- Implement GraphQL field-level caching
- Use connection pagination for large result sets
- Pre-compute `connectionCount` to avoid N+1 queries

### Caching Strategy

- Cache visualization config (rarely changes)
- Cache section metadata (rarely changes)
- Cache filtered graph queries (TTL: 5 minutes)
- Invalidate on quote/relationship updates

### Batch Operations

- Batch create relationships in single transaction
- Use bulk insert for initial data load
- Parallel sync of independent entities (sections, tags, lessons)

## Next Steps

1. **Setup Strapi Project** - Initialize Strapi with PostgreSQL
2. **Create Content Types** - Define all schemas via Strapi admin or code
3. **Run Initial Migration** - Create tables and indexes
4. **Build Sync Script** - YAML → Strapi importer
5. **Test GraphQL Queries** - Verify performance with 166+ quotes
6. **Optimize Indexes** - Profile queries and add missing indexes
7. **Implement Caching** - Add Redis or in-memory cache layer
8. **Documentation** - API docs for GraphQL queries

## Files to Create

- `strapi/` - New Strapi project directory
- `strapi/src/api/*/content-types/*/schema.json` - Content type definitions
- `strapi/database/migrations/*.js` - Migration scripts
- `web-foundations/scripts/sync-ttod-to-strapi.mjs` - Sync script
- `web-foundations/scripts/validate-ttod-schema.mjs` - YAML validation
- `strapi/config/database.js` - PostgreSQL configuration
- `strapi/config/plugins.js` - GraphQL plugin configuration