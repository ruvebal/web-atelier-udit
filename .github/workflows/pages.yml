name: Docs Portal â€” Build & Deploy (Jekyll from nested source)

on:
 push:
  branches: [main]
  paths:
   - 'web-foundations/**'
   - '_layouts/**'
   - '_includes/**'
   - 'assets/**'
   - '.github/workflows/pages.yml'
 workflow_dispatch:

permissions:
 contents: read
 pages: write
 id-token: write

concurrency:
 group: 'pages'
 cancel-in-progress: true

env:
 JEKYLL_ENV: production

jobs:
 build:
  runs-on: ubuntu-latest
  steps:
   - uses: actions/checkout@v4

   - uses: ruby/setup-ruby@v1
     with:
      ruby-version: '3.2'
      bundler-cache: true

   - uses: actions/setup-node@v4
     with:
      node-version: '20'

   - name: Install Node.js deps (web-foundations)
     working-directory: web-foundations
     run: pnpm install --frozen-lockfile

   - name: Install Jekyll deps (web-foundations)
     working-directory: web-foundations
     run: |
      bundle config set path 'vendor/bundle'
      bundle install --jobs 4 --retry 3

   - name: Build site (from nested source web-foundations/docs)
     working-directory: web-foundations
     run: |
      npm run build

   - name: Prepare artifact (flatten path)
     run: |
      rm -rf site-root
      mkdir site-root
      cp -r web-foundations/_site/* site-root/

   - name: Upload Pages artifact
     uses: actions/upload-pages-artifact@v3
     with:
      path: site-root

 deploy:
  needs: build
  runs-on: ubuntu-latest
  environment:
   name: github-pages
   url: ${{ steps.deployment.outputs.page_url }}
  steps:
   - id: deployment
     uses: actions/deploy-pages@v4
